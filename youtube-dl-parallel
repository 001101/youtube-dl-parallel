#!/bin/bash
# Copyright (c) 2013 DLH. See LICENSE.txt for the MIT license.

declare -a URLS URL_TITLES
JOBS=3
YOUTUBE_DL_ARGS=
TITLE_PADDING=0
TITLES_DIRECTORY=$(mktemp -d -t youtube-dl-parallel.XXX)
trap 'rm -r "$TITLES_DIRECTORY"' EXIT

function prefix-output() {
    local padding=$1
    local prefix=$2
    while read line; do
        printf "%-${padding}s: %s\n" "$prefix" "$line"
    done
}

function download() {
    local padding=$1
    local prefix=$2
    local url=$3
    youtube-dl $YOUTUBE_DL_ARGS --newline "$url" 2>&1 | prefix-output "$padding" "$prefix"
}

function get-title() {
    local url=$1
    local title=$(youtube-dl --ignore-config --get-title "$url" 2>&1)
    test $? -eq 0 || title="$url"
    echo "$title" > "$TITLES_DIRECTORY/$PARALLEL_SEQ"
}

function parse-options()  {
    while getopts "hj:" option "$@"; do
        case $option in
            h)
                echo "Usage: $0 [-hj] <url> [<url> ...] [-- <youtube-dl options>]"
                echo "    -h       : Shows this help message."
                echo "    -j <jobs>: The number of jobs to run in parallel. The default is 3."
                exit;;
            j)
                JOBS="$OPTARG";;
            \?)
                exit 1;;
        esac
    done
    shift $((OPTIND - 1))

    for url in "$@"; do
        if test "$url" = "--"; then
            shift
            YOUTUBE_DL_ARGS="$@"
            break
        fi
        URLS+=($url)
        shift
    done
}

function find-longest-title() {
    pushd "$TITLES_DIRECTORY" > /dev/null
    for title_file in $(ls | sort -n); do
        local title=$(cat "$title_file")
        local length=$(echo "$title" | wc -m)
        if test $length -gt $TITLE_PADDING; then
            TITLE_PADDING=$length
        fi
        URL_TITLES+=("$title")
    done
    popd > /dev/null
}

parse-options "$@"

if test -z "$URLS"; then
    echo "No urls specified. Try $0 -h for more information."
    exit 1
fi

# Export functions and variables for use with parallel
export -f prefix-output download get-title
export TITLES_DIRECTORY YOUTUBE_DL_ARGS

parallel --jobs "$JOBS" get-title ::: "${URLS[@]}"
find-longest-title
parallel --xapply --ungroup --jobs "$JOBS" "download $TITLE_PADDING {1} {2}" ::: "${URL_TITLES[@]}" ::: "${URLS[@]}"
